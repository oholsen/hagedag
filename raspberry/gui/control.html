<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GardenBot Control</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="jquery.ui.touch-punch.js"></script>
  
  <script>
  $( function() {

    $("button").button();

    $("#speedSlider").slider({
      orientation: "vertical",
      value: 0,
      min: -20,
      max: 20,
      step: 1,
      slide: function(event, ui) { 
        $("#speedText").val(ui.value ); 
      },
      change: function() { 
        var value = $(this).slider("value");
        $("#speedText").val(value); 
        //console.log("speed change", value);
        post("t " + value);
      }
    });
    $("#speedText").val($("#speedSlider").slider("value"));

    $("#turnSlider").slider({
      value: 0,
      min: -40,
      max: 40,
      step: 2,
      slide: function(event, ui) { 
        $("#turnText").val(ui.value );
      },
      change: function() { 
        var value = $(this).slider("value");
        $("#turnText").val(value);         
        // console.log("turn change", value);

        // When reversing, rotation direction, as seen from above, is opposite to 
        // natural driving intuition: rotating positive (clockwise, "right") is
        // steering left.
        // TODO: Must trigger same change in r when changing speed
        /*
        var speed = $("#speedSlider").slider("value");
        console.log("speed", speed);
        if (speed < 0)
          value = -value;
        console.log("turn change", value);
        */
        post("r " + value);
      }      
    });

    $("#turnText").val($("#turnSlider").slider("value"));

    $('#stop').on('click', function (e) {
      //console.log("Stop!", e);
      e.preventDefault();
      stop();
    });

    $('#reverse').on('click', function (e) {
      e.preventDefault();
      reverse();
    });

    $('#straight').on('click', function (e) {
      //console.log("Straight!", e);
      e.preventDefault();
      straight();
    });

    $('#reset').on('click', function (e) {
      //console.log("Reset!", e);
      e.preventDefault();
      reset();
    });

    $('#cut').on('click', function (e) {
      e.preventDefault();
      cut();
    });

    const config = document.getElementById("config");
    const output = document.getElementById("output");
    const inputBox = document.getElementById("command");
    const history = document.getElementById("history");
    const form = document.getElementById("form");

    function reset() {
      post("!");
    }

    function cut() {
      let value = $("#cutspeed").val().trim();
      post("CUT " + value);
    }

    function stop() {
      $("#speedSlider").slider("value", 0);
      $("#turnSlider").slider("value", 0);
      post("CUT 0");
    }

    function reverse() {
      let value = $("#speedSlider").slider("value");
      $("#speedSlider").slider("value", -value);
    }

    function straight() {
      $("#turnSlider").slider("value", 0);      
    }

    function step(slider, direction) {
        slider.slider("value", slider.slider("value") + direction * slider.slider("option", "step"));
    }

    document.addEventListener('keydown', (event) => {
      const keyName = event.key;
      //console.log('keypress event\n\n' + 'key: ' + keyName);
      if (keyName === 'ArrowUp')
        step($("#speedSlider"), +1);
      else if (keyName === 'ArrowDown')
        step($("#speedSlider"), -1);
      else if (keyName === 'ArrowRight')
        step($("#turnSlider"), +1);
      else if (keyName === 'ArrowLeft')
        step($("#turnSlider"), -1);
      else if (keyName === '.')
        stop();
      else if (keyName === ' ')
        straight();
    });

    try {
      // TODO: reconnect???
      const host = "ws://" + window.location.hostname + ":8000/control";
      console.log("Host:", host);
      
      var s = new WebSocket(host);
      
      var timer;
      s.onopen = function (e) {
        console.log("Socket opened.");
        timer = setInterval(() => $("#heartbeat").prop("checked") && s.send("heartbeat\n"), 3000);
      };
      
      s.onclose = function (e) {
        console.log("Socket closed.", e);
        clearInterval(timer);
      };
      
      s.onmessage = function (e) {
        const message = e.data;
        console.log("Socket message:", message);
        if (message.startsWith(" "))
          output.value = message;
        else {
          config.value += message;
          config.scrollTop = config.scrollHeight;          
        }
        if (message.startsWith("Battery ")) {
          let vbat = message.split(" ")[1];
          $('#battery').text(vbat);
        }
      };
      
      s.onerror = function (e) {
        console.log("Socket error:", e);
      };
      
    } catch (ex) {
      console.log("Socket exception:", ex);
    }

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      console.log("submit", inputBox.value);
      let value = inputBox.value + '\n';
      history.value += value;
      $('#history').scrollTop($('#history')[0].scrollHeight);
      post(value);
      inputBox.value = "";
      config.value = "";
    });


    function post(value) {
      console.log("post", value);
      s.send(value);
    }

  });
</script>

</head>

<body>

<form style="width:fit-content">
<fieldset>
<legend>Control</legend>

<div>
<div style="width: 30px">
<div style="float: left; height:200px;" id="speedSlider"></div>
</div>

<div style="margin: 30px">
<div>
  <label for="speedText">Speed:</label>
  <input type="text" id="speedText" readonly style="width: 3em; border:0; color:#f6931f; font-size:110%; font-weight:bold;">
  <button id="stop">Stop</button>
  <button id="reverse">Reverse</button>
</div>

<div style="margin-top: 20px;">
  <label for="turnText">Turn:</label>
  <input type="text" id="turnText" readonly style="width: 4em; border:0; color:#f6931f; font-size:110%; font-weight:bold;">
    <button id="straight">Straight</button>
  <div style="margin-top: 30px; width:250px" id="turnSlider"></div>
</div>
</div>

</div>
  <label for="battery">Battery:</label>
  <span id="battery"></span>
  <div>
  <button id="reset">Reset</button>
  <button id="cut">Cut</button>
</div>
<div>
</div>

</fieldset>
</form>

<p> 
  <hr>
  <p>
  <form id="form">
    <input type="text" id="command">
    <button type="submit">Command</button>
  </form>
  <form id="params">
    <input type="text" id="cutspeed" value="14">
    <input type="checkbox" id="heartbeat"> Hearbeat
  </form>

<table>
<tr>
<td>
  <textarea id="history" rows="8" readonly></textarea>
</td>
<td>
  <textarea id="config" rows="8" readonly></textarea>
</td>
</tr>
<tr>
<td colspan="2">
  <textarea id="output" rows="5" readonly></textarea>
</td>
</tr>
</table>

</body>
</html>
